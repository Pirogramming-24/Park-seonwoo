{% extends 'base.html' %}

{% block content %}
<style>
    .post-card {
        max-width: 614px;
        margin: 0 auto 24px;
    }
    .post-header {
        padding: 14px 16px;
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .post-header img {
        width: 32px;
        height: 32px;
        border-radius: 50%;
    }
    .post-header strong {
        font-size: 14px;
        font-weight: 600;
    }
    .post-image {
        width: 100%;
        display: block;
    }
    .post-actions {
        padding: 8px 16px;
    }
    .post-actions button {
        background: none;
        border: none;
        font-size: 24px;
        cursor: pointer;
        padding: 8px;
    }
    .post-likes {
        padding: 0 16px;
        font-size: 14px;
        font-weight: 600;
    }
    .post-content {
        padding: 8px 16px;
        font-size: 14px;
    }
    .post-comments {
        padding: 0 16px 12px;
    }
    .post-comments a {
        font-size: 14px;
        color: #8e8e8e;
    }
    .post-time {
        padding: 0 16px 12px;
        font-size: 12px;
        color: #8e8e8e;
    }
    .empty-state {
        text-align: center;
        padding: 60px 20px;
    }
    .empty-state h2 {
        font-size: 24px;
        margin-bottom: 16px;
    }
    .empty-state p {
        color: #8e8e8e;
        font-size: 14px;
        margin-bottom: 20px;
    }
</style>

<div style="max-width: 614px; margin: 0 auto;">
    <!-- ìŠ¤í† ë¦¬ ì„¹ì…˜ -->
     <div class="card" style="padding: 12px; margin-bottom: 24px; display: flex; justify-content: center;">
        <form action="" method="GET" style="width: 100%; display: flex; gap: 8px;">
            <input type="text" name="q" value="{{ query|default:'' }}" 
                   placeholder="ê²€ìƒ‰ (ë‚´ìš©, ì‘ì„±ì)" 
                   style="flex: 1; padding: 8px 12px; background: #fafafa; border: 1px solid #dbdbdb; border-radius: 4px;">
            <button type="submit" 
                    style="padding: 8px 16px; background: #0095f6; color: white; border: none; border-radius: 4px; font-weight: 600; cursor: pointer;">
                ê²€ìƒ‰
            </button>
        </form>
    </div>
    <div class="card" style="padding: 16px; margin-bottom: 24px;">
        <div style="display: flex; gap: 16px; overflow-x: auto; padding-bottom: 8px;">
            <a href="{% url 'stories:create' %}" style="text-align: center; min-width: 64px;">
                <div style="width: 64px; height: 64px; border-radius: 50%; border: 2px dashed #dbdbdb; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                    â•
                </div>
                <div style="font-size: 12px; margin-top: 4px; color: #262626;">ë‚´ ìŠ¤í† ë¦¬</div>
            </a>
            
            {% comment %} íŒ”ë¡œìš°í•œ ì‚¬ëŒë“¤ì˜ ìŠ¤í† ë¦¬ í‘œì‹œ {% endcomment %}
            {% for story in stories %}
            <a href="{% url 'stories:view' story.pk %}" style="text-align: center; min-width: 64px;">
                {% if story.images.first %}
                <img src="{{ story.images.first.image.url }}" style="width: 64px; height: 64px; border-radius: 50%; object-fit: cover; border: 3px solid #e1306c;">
                {% else %}
                <div style="width: 64px; height: 64px; border-radius: 50%; background: #dbdbdb; border: 3px solid #e1306c;"></div>
                {% endif %}
                <div style="font-size: 12px; margin-top: 4px; color: #262626;">{{ story.author.username }}</div>
            </a>
            {% endfor %}
        </div>
    </div>

    <!-- ê²Œì‹œê¸€ í”¼ë“œ -->
    {% for post in posts %}
    <div class="card post-card">
        <div class="post-header">
            <a href="{% url 'users:profile' post.author.username %}">
                {% if post.author.profile_image %}
                <img src="{{ post.author.profile_image.url }}" alt="{{ post.author.username }}">
                {% else %}
                <div style="width: 32px; height: 32px; border-radius: 50%; background: #dbdbdb;"></div>
                {% endif %}
            </a>
            <a href="{% url 'users:profile' post.author.username %}" style="color: #262626;">
                <strong>{{ post.author.username }}</strong>
            </a>
            
            {% if post.author == user %}
            <div style="margin-left: auto; display: flex; gap: 8px;">
                <a href="{% url 'posts:update' post.pk %}" style="font-size: 12px;">ìˆ˜ì •</a>
                <a href="{% url 'posts:delete' post.pk %}" onclick="return confirm('ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')" style="font-size: 12px; color: #ed4956;">ì‚­ì œ</a>
            </div>
            {% endif %}
        </div>
        
        {% if post.image %}
        <img src="{{ post.image.url }}" class="post-image" alt="ê²Œì‹œê¸€ ì´ë¯¸ì§€">
        {% endif %}
        
        <div class="post-actions">
            <button id="like-btn-{{ post.pk }}" onclick="likePost({{ post.pk }})" style="background:none; border:none; cursor:pointer; font-size:24px;">
                {% if user in post.likes.all %}â¤ï¸{% else %}ğŸ¤{% endif %}
            </button>   
            <a href="{% url 'posts:detail' post.pk %}">
                <button>ğŸ’¬</button>
            </a>
        </div>
        
        <div class="post-likes">
            ì¢‹ì•„ìš” {{ post.likes_count }}ê°œ
        </div>
        
        <div class="post-content">
            <strong>{{ post.author.username }}</strong> {{ post.content }}
        </div>
        
        <div class="post-comments">
            <a href="{% url 'posts:detail' post.pk %}">ëŒ“ê¸€ {{ post.comments_count }}ê°œ ëª¨ë‘ ë³´ê¸°</a>
        </div>
        
        <div class="post-time">
            {{ post.created_at|date:"Yë…„ mì›” dì¼" }}
        </div>
    </div>
    {% empty %}
    <div class="card empty-state">
        <h2>í™˜ì˜í•©ë‹ˆë‹¤! ğŸ‘‹</h2>
        <p>íŒ”ë¡œìš°í•œ ì‚¬ëŒì´ ì—†ê±°ë‚˜ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        <a href="{% url 'users:search' %}" class="btn">ì¹œêµ¬ ì°¾ê¸°</a>
    </div>
    {% endfor %}
</div>
<script>
    function likePost(postId) {
        fetch(`/posts/${postId}/like/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            const btn = document.getElementById(`like-btn-${postId}`);
            btn.innerText = data.liked ? 'â¤ï¸' : 'ğŸ¤';
            
            const likeCountDiv = btn.closest('.post-card').querySelector('.post-likes');
            if(likeCountDiv) likeCountDiv.innerText = `ì¢‹ì•„ìš” ${data.likes_count}ê°œ`;
        })
        .catch(error => console.error('Error:', error));
    }
</script>
{% endblock %}