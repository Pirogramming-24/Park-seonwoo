{% extends 'base.html' %}
{% block head %}
<title>post_create</title>
<style>
  main {
    height: 100vh;
  }

  #ocrStatus {
    margin-top: 8px;
  }
</style>
{% endblock %}

{% block content %}
<form action="{% url 'posts:create' %}" method="POST" enctype="multipart/form-data">
  {% csrf_token %}

  <h3>ê²Œì‹œê¸€ ì •ë³´</h3>
  {{ post_form.as_p }}

  <p>
    ì˜ì–‘ ì„±ë¶„ ì´ë¯¸ì§€:
    <input type="file" id="nutritionImage" accept="image/*">
    <div id="ocrStatus"></div>
  </p>

  {{ nutrition_form.as_p }}

  <button class="btn btn-success">ë“±ë¡í•˜ê¸°</button>
</form>

<script>
  const fileInput = document.getElementById("nutritionImage");
  // í¼ í•„ë“œ ID (create.htmlì˜ ì‹¤ì œ IDì™€ ì¼ì¹˜í•´ì•¼ í•¨)
  const caloriesEl = document.getElementById("id_calories_kcal"); // ë³´í†µ id_í•„ë“œëª… ì…ë‹ˆë‹¤.
  const carbsEl = document.getElementById("id_carbs_g");
  const proteinEl = document.getElementById("id_protein_g");
  const fatEl = document.getElementById("id_fat_g");

  function getCsrfToken() {
    const name = "csrftoken=";
    const parts = document.cookie.split(";").map(v => v.trim());
    for (const p of parts) if (p.startsWith(name)) return p.slice(name.length);
    return "";
  }

  function setAnalyzingUI(on) {
    const msg = on ? "ë¶„ì„ ì¤‘..." : "";
    const fields = [caloriesEl, carbsEl, proteinEl, fatEl].filter(Boolean);

    fields.forEach(el => {
      if (on) {
        el.placeholder = msg;
        el.value = ""; // ë¶„ì„ ì‹œì‘í•˜ë©´ ê¸°ì¡´ ê°’ ë¹„ì›€
        // el.disabled = true; // (ì„ íƒì‚¬í•­) ë¶„ì„ ì¤‘ ìˆ˜ì • ëª»í•˜ê²Œ ë§‰ìœ¼ë ¤ë©´ ì£¼ì„ í•´ì œ
      } else {
        el.placeholder = "";
        el.disabled = false;
      }
    });
  }

  fileInput?.addEventListener("change", async () => {
    const file = fileInput.files?.[0];
    if (!file) return;

    setAnalyzingUI(true); // "ë¶„ì„ ì¤‘..." í‘œì‹œ

    const fd = new FormData();
    fd.append("nutrition_image", file); // ë·°ì—ì„œ ë°›ëŠ” ì´ë¦„ê³¼ ì¼ì¹˜

    try {
      // â˜… 1. URL ìˆ˜ì • ì™„ë£Œ ('posts:ocr_api')
      const res = await fetch("{% url 'posts:ocr_api' %}", {
        method: "POST",
        headers: { "X-CSRFToken": getCsrfToken() },
        body: fd
      });

      const data = await res.json();

      // â˜… 2. ë°ì´í„° ì²˜ë¦¬ ìˆ˜ì • (views.pyê°€ ë³´ë‚´ì£¼ëŠ” í˜•ì‹ì— ë§ì¶¤)
      // views.py: return JsonResponse({'success': True, 'data': ...})
      
      if (!data.success) { // !data.ok ê°€ ì•„ë‹ˆë¼ !data.success
        setAnalyzingUI(false);
        alert("OCR ì‹¤íŒ¨: " + (data.error || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜"));
        return;
      }

      // views.pyê°€ ë³´ë‚¸ ë°ì´í„°ëŠ” data.data ì•ˆì— ìˆìŒ
      const n = data.data || {}; 

      // ê°’ ì±„ìš°ê¸°
      if (caloriesEl) caloriesEl.value = n.kcal || 0;     // rules.py í‚¤: kcal
      if (carbsEl) carbsEl.value = n.carbohydrate || 0;   // rules.py í‚¤: carbohydrate
      if (proteinEl) proteinEl.value = n.protein || 0;    // rules.py í‚¤: protein
      if (fatEl) fatEl.value = n.fat || 0;                // rules.py í‚¤: fat

      setAnalyzingUI(false); // UI ë³µêµ¬
      alert("ë¶„ì„ ì™„ë£Œ! ìˆ«ìë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”. ğŸ");

    } catch (e) {
      setAnalyzingUI(false);
      console.error(e);
      alert("ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  });
</script>
{% endblock %}